<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WriteMagic AI Proxy Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #1f2937;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .status-item {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
            text-align: center;
        }
        .status-healthy { background: #dcfce7; color: #166534; }
        .status-unhealthy { background: #fee2e2; color: #dc2626; }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        textarea, select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }
        textarea {
            min-height: 120px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .error {
            background: #fee2e2;
            border-left-color: #dc2626;
            color: #dc2626;
        }
        .success {
            background: #dcfce7;
            border-left-color: #16a34a;
            color: #16a34a;
        }
        .metadata {
            font-size: 12px;
            color: #6b7280;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #6b7280;
            margin-right: 0;
            margin-bottom: 0;
        }
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .usage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-item {
            padding: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WriteMagic AI Proxy Demo</h1>
            <p>Test the secure AI proxy service with provider fallback and caching</p>
        </div>

        <!-- Status Dashboard -->
        <div class="status">
            <div class="status-item" id="proxy-status">
                <strong>Proxy Service</strong><br>
                <span id="proxy-status-text">Checking...</span>
            </div>
            <div class="status-item" id="provider-status">
                <strong>AI Providers</strong><br>
                <span id="provider-status-text">Checking...</span>
            </div>
            <div class="status-item" id="cache-status">
                <strong>Response Cache</strong><br>
                <span id="cache-status-text">Checking...</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('completion')">Text Completion</button>
            <button class="tab" onclick="switchTab('chat')">AI Chat</button>
            <button class="tab" onclick="switchTab('writing')">Writing Assistant</button>
            <button class="tab" onclick="switchTab('admin')">Admin</button>
        </div>

        <!-- Text Completion Tab -->
        <div class="tab-content active" id="completion-tab">
            <div class="form-group">
                <label for="completion-prompt">Enter your prompt:</label>
                <textarea id="completion-prompt" placeholder="Write a short poem about artificial intelligence...">Write a brief introduction to the benefits of secure AI proxy services for web applications.</textarea>
            </div>
            
            <div class="form-group">
                <label for="completion-model">Model (optional):</label>
                <select id="completion-model">
                    <option value="">Auto (provider fallback)</option>
                    <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
            </div>

            <div class="form-group">
                <label for="completion-tokens">Max Tokens:</label>
                <input type="number" id="completion-tokens" value="500" min="1" max="4000">
            </div>

            <div class="form-group">
                <label for="completion-temperature">Temperature:</label>
                <input type="number" id="completion-temperature" value="0.7" min="0" max="2" step="0.1">
            </div>

            <button onclick="testCompletion()" id="completion-btn">Generate Completion</button>
            <div id="completion-result"></div>
        </div>

        <!-- Chat Tab -->
        <div class="tab-content" id="chat-tab">
            <div class="form-group">
                <label for="chat-message">Your Message:</label>
                <textarea id="chat-message" placeholder="Hello! Can you help me improve my writing skills?">What are the key principles of effective technical writing?</textarea>
            </div>
            
            <button onclick="testChat()" id="chat-btn">Send Message</button>
            <button onclick="clearChat()" id="clear-chat-btn">Clear Conversation</button>
            
            <div id="chat-result"></div>
        </div>

        <!-- Writing Assistant Tab -->
        <div class="tab-content" id="writing-tab">
            <div class="form-group">
                <label for="writing-text">Text to Improve:</label>
                <textarea id="writing-text" placeholder="Enter text that needs improvement...">This is a sentence that could be wrote better and more clear for readers to understand what I am trying to say.</textarea>
            </div>

            <div class="form-group">
                <label for="writing-type">Improvement Type:</label>
                <select id="writing-type">
                    <option value="improve">General Improvement</option>
                    <option value="grammar">Grammar & Spelling</option>
                    <option value="clarity">Clarity & Flow</option>
                    <option value="style">Style & Tone</option>
                    <option value="expand">Expand Ideas</option>
                    <option value="summarize">Summarize</option>
                </select>
            </div>

            <button onclick="improveWriting()" id="writing-btn">Improve Text</button>
            <div id="writing-result"></div>
        </div>

        <!-- Admin Tab -->
        <div class="tab-content" id="admin-tab">
            <h3>System Information</h3>
            <button onclick="checkHealth()">Refresh Health Status</button>
            <button onclick="getCacheStats()">Get Cache Statistics</button>
            <button onclick="clearCache()">Clear Cache</button>
            <button onclick="getProviders()">List Providers</button>
            
            <div class="usage-stats" id="usage-stats">
                <div class="stat-item">
                    <div class="stat-value" id="requests-count">0</div>
                    <div class="stat-label">Requests</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="tokens-count">0</div>
                    <div class="stat-label">Tokens Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cache-hits">0</div>
                    <div class="stat-label">Cache Hits</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-response">0ms</div>
                    <div class="stat-label">Avg Response</div>
                </div>
            </div>

            <div id="admin-result"></div>
        </div>
    </div>

    <script>
        // Global state
        let conversationId = null;
        let requestCount = 0;
        let totalTokens = 0;
        let totalResponseTime = 0;
        let cacheHits = 0;

        const BASE_URL = 'http://localhost:3001';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkHealth();
            await getCacheStats();
        });

        // Tab management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Utility functions
        function showResult(elementId, content, type = 'result') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = `result ${type}`;
        }

        function updateStats() {
            document.getElementById('requests-count').textContent = requestCount;
            document.getElementById('tokens-count').textContent = totalTokens;
            document.getElementById('cache-hits').textContent = cacheHits;
            document.getElementById('avg-response').textContent = 
                requestCount > 0 ? Math.round(totalResponseTime / requestCount) + 'ms' : '0ms';
        }

        async function makeRequest(url, options = {}) {
            const startTime = Date.now();
            
            try {
                const response = await fetch(BASE_URL + url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-ID': `demo_${Date.now()}_${Math.random().toString(36).substring(2)}`,
                    },
                    credentials: 'include',
                    ...options,
                });

                const responseTime = Date.now() - startTime;
                totalResponseTime += responseTime;
                requestCount++;

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(`HTTP ${response.status}: ${error.message || response.statusText}`);
                }

                const data = await response.json();
                
                // Track cache hits
                if (data.metadata && data.metadata.cached) {
                    cacheHits++;
                }

                // Track tokens
                if (data.usage && data.usage.total_tokens) {
                    totalTokens += data.usage.total_tokens;
                }

                updateStats();
                return data;

            } catch (error) {
                const responseTime = Date.now() - startTime;
                totalResponseTime += responseTime;
                requestCount++;
                updateStats();
                throw error;
            }
        }

        // Test functions
        async function testCompletion() {
            const btn = document.getElementById('completion-btn');
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                const prompt = document.getElementById('completion-prompt').value;
                const model = document.getElementById('completion-model').value;
                const maxTokens = parseInt(document.getElementById('completion-tokens').value);
                const temperature = parseFloat(document.getElementById('completion-temperature').value);

                if (!prompt.trim()) {
                    throw new Error('Please enter a prompt');
                }

                const requestBody = {
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: maxTokens,
                    temperature: temperature,
                };

                if (model) {
                    requestBody.model = model;
                }

                const response = await makeRequest('/api/ai/complete', {
                    body: JSON.stringify(requestBody),
                });

                const content = response.choices[0].message.content;
                const metadata = `
                    <div class="metadata">
                        <strong>Provider:</strong> ${response.metadata.provider} | 
                        <strong>Model:</strong> ${response.model} | 
                        <strong>Tokens:</strong> ${response.usage.total_tokens} | 
                        <strong>Time:</strong> ${response.metadata.processingTime}ms | 
                        <strong>Cached:</strong> ${response.metadata.cached ? 'Yes' : 'No'}
                    </div>
                `;

                showResult('completion-result', `<strong>Generated Content:</strong><br><br>${content}${metadata}`, 'success');

            } catch (error) {
                showResult('completion-result', `<strong>Error:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Completion';
            }
        }

        async function testChat() {
            const btn = document.getElementById('chat-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const message = document.getElementById('chat-message').value;

                if (!message.trim()) {
                    throw new Error('Please enter a message');
                }

                const requestBody = {
                    message: message,
                    conversation_id: conversationId,
                };

                const response = await makeRequest('/api/ai/chat', {
                    body: JSON.stringify(requestBody),
                });

                conversationId = response.conversationId;

                const content = `
                    <strong>You:</strong> ${message}<br><br>
                    <strong>Assistant:</strong> ${response.message}
                `;

                const metadata = `
                    <div class="metadata">
                        <strong>Provider:</strong> ${response.provider} | 
                        <strong>Conversation ID:</strong> ${response.conversationId} | 
                        <strong>Tokens:</strong> ${response.usage.total_tokens} | 
                        <strong>Time:</strong> ${response.metadata.processingTime}ms
                    </div>
                `;

                showResult('chat-result', content + metadata, 'success');

                // Clear message input
                document.getElementById('chat-message').value = '';

            } catch (error) {
                showResult('chat-result', `<strong>Error:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Message';
            }
        }

        function clearChat() {
            conversationId = null;
            showResult('chat-result', '<em>Conversation cleared. Next message will start a new conversation.</em>', 'result');
        }

        async function improveWriting() {
            const btn = document.getElementById('writing-btn');
            btn.disabled = true;
            btn.textContent = 'Improving...';

            try {
                const text = document.getElementById('writing-text').value;
                const type = document.getElementById('writing-type').value;

                if (!text.trim()) {
                    throw new Error('Please enter text to improve');
                }

                const prompts = {
                    improve: `Please improve this text for better clarity, flow, and impact while maintaining the author's voice:\n\n${text}`,
                    grammar: `Please fix any grammar, spelling, and punctuation errors in this text:\n\n${text}`,
                    clarity: `Please rewrite this text to be clearer and easier to understand:\n\n${text}`,
                    style: `Please improve the style and tone of this text to be more engaging:\n\n${text}`,
                    expand: `Please expand on this text with additional details and examples:\n\n${text}`,
                    summarize: `Please provide a concise summary of this text:\n\n${text}`,
                };

                const prompt = prompts[type] || prompts.improve;

                const response = await makeRequest('/api/ai/complete', {
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a professional writing assistant. Provide helpful improvements while maintaining the author\'s voice and intent.',
                            },
                            { role: 'user', content: prompt },
                        ],
                        max_tokens: 1000,
                        temperature: 0.3,
                    }),
                });

                const improved = response.choices[0].message.content;
                const originalWordCount = text.split(/\s+/).filter(w => w).length;
                const improvedWordCount = improved.split(/\s+/).filter(w => w).length;

                const content = `
                    <strong>Original Text:</strong><br>
                    <div style="padding: 10px; background: #f3f4f6; border-radius: 4px; margin: 10px 0;">${text}</div>
                    
                    <strong>Improved Text:</strong><br>
                    <div style="padding: 10px; background: #dcfce7; border-radius: 4px; margin: 10px 0;">${improved}</div>
                `;

                const metadata = `
                    <div class="metadata">
                        <strong>Improvement Type:</strong> ${type} | 
                        <strong>Provider:</strong> ${response.metadata.provider} | 
                        <strong>Words:</strong> ${originalWordCount} → ${improvedWordCount} | 
                        <strong>Tokens:</strong> ${response.usage.total_tokens} | 
                        <strong>Time:</strong> ${response.metadata.processingTime}ms
                    </div>
                `;

                showResult('writing-result', content + metadata, 'success');

            } catch (error) {
                showResult('writing-result', `<strong>Error:</strong> ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Improve Text';
            }
        }

        // Admin functions
        async function checkHealth() {
            try {
                const response = await fetch(BASE_URL + '/api/ai/providers/health');
                const health = await response.json();

                // Update proxy status
                const proxyStatus = document.getElementById('proxy-status');
                const proxyText = document.getElementById('proxy-status-text');
                proxyText.textContent = 'Online';
                proxyStatus.className = 'status-item status-healthy';

                // Update provider status
                const providerStatus = document.getElementById('provider-status');
                const providerText = document.getElementById('provider-status-text');
                providerText.textContent = health.status;
                providerStatus.className = health.status === 'healthy' ? 
                    'status-item status-healthy' : 'status-item status-unhealthy';

                // Show detailed health info
                const healthInfo = Object.entries(health.providers)
                    .map(([name, info]) => `${name}: ${info.status}`)
                    .join('<br>');

                showResult('admin-result', `
                    <strong>Provider Health Details:</strong><br>
                    ${healthInfo}<br><br>
                    <strong>Overall Status:</strong> ${health.status}<br>
                    <strong>Last Check:</strong> ${health.timestamp}
                `, 'success');

            } catch (error) {
                document.getElementById('proxy-status-text').textContent = 'Offline';
                document.getElementById('proxy-status').className = 'status-item status-unhealthy';
                document.getElementById('provider-status-text').textContent = 'Unknown';
                showResult('admin-result', `<strong>Health Check Error:</strong> ${error.message}`, 'error');
            }
        }

        async function getCacheStats() {
            try {
                const response = await fetch(BASE_URL + '/api/ai/cache/stats');
                const stats = await response.json();

                // Update cache status
                const cacheStatus = document.getElementById('cache-status');
                const cacheText = document.getElementById('cache-status-text');
                cacheText.textContent = `${stats.cache.keys} items`;
                cacheStatus.className = 'status-item status-healthy';

                const cacheInfo = `
                    <strong>Cache Statistics:</strong><br>
                    Items: ${stats.cache.keys}<br>
                    Hit Rate: ${Math.round(stats.cache.hitRate * 100)}%<br>
                    Hits: ${stats.cache.hits}<br>
                    Misses: ${stats.cache.misses}<br><br>
                    <strong>Memory Usage:</strong><br>
                    RSS: ${Math.round(stats.cache.memoryUsage.rss / 1024 / 1024)}MB<br>
                    Heap Used: ${Math.round(stats.cache.memoryUsage.heapUsed / 1024 / 1024)}MB<br>
                    Heap Total: ${Math.round(stats.cache.memoryUsage.heapTotal / 1024 / 1024)}MB
                `;

                showResult('admin-result', cacheInfo, 'success');

            } catch (error) {
                document.getElementById('cache-status-text').textContent = 'Unknown';
                showResult('admin-result', `<strong>Cache Stats Error:</strong> ${error.message}`, 'error');
            }
        }

        async function clearCache() {
            try {
                const response = await fetch(BASE_URL + '/api/ai/cache/clear', { method: 'POST' });
                const result = await response.json();

                showResult('admin-result', `
                    <strong>Cache Cleared:</strong><br>
                    ${result.message}<br>
                    Cleared at: ${result.result.timestamp}
                `, 'success');

                // Refresh cache stats
                setTimeout(getCacheStats, 1000);

            } catch (error) {
                showResult('admin-result', `<strong>Clear Cache Error:</strong> ${error.message}`, 'error');
            }
        }

        async function getProviders() {
            try {
                const response = await fetch(BASE_URL + '/api/ai/providers');
                const data = await response.json();

                const providerInfo = data.providers.map(provider => `
                    <strong>${provider.name}:</strong><br>
                    Model: ${provider.config.defaultModel}<br>
                    Max Tokens: ${provider.config.maxTokens}<br>
                    Temperature: ${provider.config.temperature}<br>
                `).join('<br>');

                showResult('admin-result', `
                    <strong>Available Providers:</strong><br><br>
                    ${providerInfo}<br>
                    <strong>Default Provider:</strong> ${data.defaultProvider}<br>
                    <strong>Fallback Order:</strong> ${data.fallbackOrder.join(' → ')}
                `, 'success');

            } catch (error) {
                showResult('admin-result', `<strong>Get Providers Error:</strong> ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>